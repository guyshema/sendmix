<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>oppenmasters | Pre-Mastering Mix Check</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: #f4f4f5;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }

        body.rtl {
            direction: rtl;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Language Toggle */
        .lang-toggle {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .lang-btn {
            padding: 8px 16px;
            border: 1px solid #3f3f46;
            background: transparent;
            color: #71717a;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .lang-btn:hover {
            border-color: #c9a227;
            color: #c9a227;
        }

        .lang-btn.active {
            background: #c9a227;
            border-color: #c9a227;
            color: #000;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 4px;
        }

        .logo span {
            color: #c9a227;
        }

        .tagline {
            color: #71717a;
            font-size: 14px;
        }

        /* Upload Area */
        .upload-area {
            background: rgba(255,255,255,0.03);
            border: 2px dashed #3f3f46;
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #c9a227;
            background: rgba(201, 162, 39, 0.05);
        }

        .upload-area.has-file {
            border-style: solid;
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-text {
            font-size: 16px;
            color: #a1a1aa;
            margin-bottom: 8px;
        }

        .upload-formats {
            font-size: 12px;
            color: #52525b;
        }

        .file-info {
            display: none;
            background: rgba(201, 162, 39, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .file-info.show { display: block; }

        .file-name {
            font-weight: 600;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .file-meta {
            font-size: 13px;
            color: #a1a1aa;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show { display: block; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #27272a;
            border-top-color: #c9a227;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Results */
        .results {
            display: none;
        }

        .results.show { display: block; }

        /* Status Card */
        .status-card {
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid transparent;
        }

        .status-card.ready {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.08);
        }

        .status-card.warning {
            border-color: #eab308;
            background: rgba(234, 179, 8, 0.08);
        }

        .status-card.issues {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.08);
        }

        .status-icon {
            font-size: 56px;
            margin-bottom: 12px;
        }

        .status-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .status-desc {
            color: #a1a1aa;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 16px;
        }

        .metric-card.full {
            grid-column: span 2;
        }

        .metric-label {
            font-size: 12px;
            color: #71717a;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .metric-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .metric-status.good {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .metric-status.warn {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .metric-status.bad {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Issues List */
        .issues-section {
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
        }

        .issues-section.show { display: block; }

        .issues-title {
            font-weight: 600;
            color: #ef4444;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .issue-item {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .issue-item:last-child { margin-bottom: 0; }

        .issue-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .issue-desc {
            font-size: 13px;
            color: #a1a1aa;
        }

        /* Instructions */
        .instructions {
            background: rgba(201, 162, 39, 0.08);
            border: 1px solid rgba(201, 162, 39, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .instructions-title {
            font-weight: 600;
            color: #c9a227;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instruction-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .instruction-item:last-child { margin-bottom: 0; }

        .instruction-num {
            background: #c9a227;
            color: #000;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }

        /* Guidelines Panel */
        .guidelines {
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .guidelines-header {
            background: rgba(201, 162, 39, 0.1);
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .guidelines-header:hover {
            background: rgba(201, 162, 39, 0.15);
        }

        .guidelines-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .guidelines-content {
            display: none;
            padding: 16px;
        }

        .guidelines-content.show { display: block; }

        .guideline-section {
            margin-bottom: 16px;
        }

        .guideline-section:last-child { margin-bottom: 0; }

        .guideline-section h4 {
            color: #c9a227;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .guideline-section ul {
            list-style: none;
            font-size: 13px;
            color: #a1a1aa;
        }

        .guideline-section li {
            padding: 4px 0;
            padding-left: 16px;
            position: relative;
        }

        body.rtl .guideline-section li {
            padding-left: 0;
            padding-right: 16px;
        }

        .guideline-section li::before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #c9a227;
        }

        body.rtl .guideline-section li::before {
            left: auto;
            right: 0;
        }

        /* Player */
        .player {
            display: none;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .player.show { display: block; }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .play-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #c9a227;
            border: none;
            color: #000;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .play-btn:hover {
            background: #d4af37;
        }

        .player-info {
            flex: 1;
        }

        .player-time {
            font-size: 12px;
            color: #71717a;
            margin-bottom: 6px;
        }

        .progress-bar {
            height: 6px;
            background: #27272a;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #c9a227;
            width: 0%;
            transition: width 0.1s;
        }

        /* Reset Button */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .pdf-btn, .reset-btn {
            flex: 1;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .pdf-btn {
            background: linear-gradient(135deg, #c9a227, #d4af37);
            border: none;
            color: #000;
        }

        .pdf-btn:hover {
            background: linear-gradient(135deg, #d4af37, #e5c158);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 162, 39, 0.3);
        }

        .reset-btn {
            background: transparent;
            border: 2px solid #3f3f46;
            color: #a1a1aa;
        }

        .reset-btn:hover {
            border-color: #c9a227;
            color: #c9a227;
        }

        .btn-icon {
            font-size: 18px;
        }

        .btn-text {
            white-space: nowrap;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #52525b;
            font-size: 12px;
        }

        .footer a {
            color: #c9a227;
            text-decoration: none;
        }

        /* Frequency Balance 3-Band */
        .freq-balance {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .freq-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .freq-note {
            font-size: 11px;
            color: #71717a;
            margin-bottom: 16px;
        }

        .freq-3band {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .freq-band {
            display: grid;
            grid-template-columns: 70px 75px 1fr 50px;
            align-items: center;
            gap: 12px;
        }

        .freq-band-label {
            font-weight: 600;
            font-size: 14px;
            color: #f4f4f5;
        }

        .freq-band-range {
            font-size: 11px;
            color: #71717a;
        }

        .freq-band-bar-wrap {
            height: 24px;
            background: #1a1a2e;
            border-radius: 6px;
            overflow: hidden;
        }

        .freq-band-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .freq-band-bar.low {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }

        .freq-band-bar.mid {
            background: linear-gradient(90deg, #22c55e, #4ade80);
        }

        .freq-band-bar.high {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .freq-band-value {
            font-size: 16px;
            font-weight: 700;
            color: #f4f4f5;
            text-align: right;
        }

        .freq-reference {
            margin-top: 16px;
            padding: 10px 14px;
            background: rgba(201, 162, 39, 0.1);
            border-radius: 8px;
            border-left: 3px solid #c9a227;
            font-size: 12px;
            color: #a1a1aa;
        }

        body.rtl .freq-reference {
            border-left: none;
            border-right: 3px solid #c9a227;
        }

        /* Spectrum */
        .spectrum {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .spectrum-title {
            font-size: 12px;
            color: #71717a;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }

        .spectrum-bars {
            display: flex;
            align-items: flex-end;
            height: 80px;
            gap: 2px;
        }

        .spectrum-bar {
            flex: 1;
            background: linear-gradient(to top, #c9a227, #d4af37);
            min-height: 4px;
            border-radius: 2px 2px 0 0;
            transition: height 0.1s;
        }

        .spectrum-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #52525b;
            margin-top: 8px;
        }

        .live-badge {
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Hidden input */
        input[type="file"] { display: none; }

        /* Checklist */
        .checklist {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .checklist-title {
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .check-item:last-child { border-bottom: none; }

        .check-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .check-icon.pass {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .check-icon.fail {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .check-icon.warn {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .check-text {
            flex: 1;
            font-size: 14px;
        }

        .check-value {
            font-size: 13px;
            color: #71717a;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Language Toggle -->
        <div class="lang-toggle">
            <button class="lang-btn active" id="langEn" onclick="setLang('en')">English</button>
            <button class="lang-btn" id="langHe" onclick="setLang('he')">×¢×‘×¨×™×ª</button>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="logo"><span>oppen</span>masters</div>
            <div class="tagline" data-en="Pre-Mastering Mix Check" data-he="×‘×“×™×§×ª ××™×§×¡ ×œ×¤× ×™ ×××¡×˜×¨×™× ×’"></div>
        </div>

        <!-- Guidelines -->
        <div class="guidelines">
            <div class="guidelines-header" id="guidelinesHeader">
                <div class="guidelines-title">ğŸ“– <span data-en="Submission Guidelines" data-he="×”× ×—×™×•×ª ×”×’×©×” ×œ×××¡×˜×¨×™× ×’">Submission Guidelines</span></div>
                <span id="guidelinesArrow">â–²</span>
            </div>
            <div class="guidelines-content show" id="guidelinesContent">
                <!-- English Guidelines -->
                <div class="lang-content" data-lang="en">
                    <div class="guideline-section">
                        <h4>Required Files</h4>
                        <ul>
                            <li><strong>Reference Master</strong> - Keep ALL your processing! Don't remove anything. I want to hear your vision, intention and energy as-is</li>
                            <li><strong>Clean Mix</strong> - Without master bus processing (no limiter/maximizer)</li>
                            <li>Original Sample Rate - don't convert!</li>
                            <li>Original Bit Depth</li>
                            <li>No Dither applied</li>
                        </ul>
                    </div>
                    <div class="guideline-section">
                        <h4>Volume & Headroom</h4>
                        <ul>
                            <li><strong>Don't mix too quiet!</strong> A very low mix level wastes bit-depth resolution - keep healthy levels</li>
                            <li>In a busy/dense mix, it's totally fine to get close to 0dB - as long as there's no clipping</li>
                            <li>No need to hit -6dB exactly - just avoid clipping</li>
                            <li>No Limiter/Maximizer on Clean Mix</li>
                        </ul>
                    </div>
                    <div class="guideline-section">
                        <h4>What NOT to Do</h4>
                        <ul>
                            <li>Don't change Sample Rate</li>
                            <li>Don't Normalize</li>
                            <li>Don't apply SRC/Resampling</li>
                            <li>Don't add processing to Mix Bus on clean version</li>
                        </ul>
                    </div>
                    <div class="guideline-section">
                        <h4>File Names</h4>
                        <ul>
                            <li>Artist â€“ Track â€“ MIX</li>
                            <li>Artist â€“ Track â€“ MASTER REF</li>
                            <li>Format: WAV or AIFF only</li>
                        </ul>
                    </div>
                </div>
                <!-- Hebrew Guidelines -->
                <div class="lang-content" data-lang="he" style="display:none;">
                    <div class="guideline-section">
                        <h4>×§×‘×¦×™× × ×“×¨×©×™×</h4>
                        <ul>
                            <li><strong>Reference Master</strong> - ×”×©××™×¨×• ××ª ×›×œ ×”×¢×™×‘×•×“×™×! ××œ ×ª×•×¨×™×“×• ×©×•× ×“×‘×¨. ×× ×™ ×¨×•×¦×” ×œ×©××•×¢ ××ª ×”×—×–×•×Ÿ, ×”×›×•×•× ×” ×•×”×× ×¨×’×™×” ×”××§×•×¨×™×ª ×©×œ×›× ×›××• ×©×”×™×</li>
                            <li><strong>Clean Mix</strong> - ×œ×œ× ×¢×™×‘×•×“×™ ×××¡×˜×¨ ×¢×œ ×”××™×§×¡ ×‘××¡ (×œ×œ× ×œ×™××™×˜×¨/××§×¡×™××™×™×–×¨)</li>
                            <li>Sample Rate ××§×•×¨×™ - ×œ× ×œ×©× ×•×ª!</li>
                            <li>Bit Depth ××§×•×¨×™</li>
                            <li>×œ×œ× Dither</li>
                        </ul>
                    </div>
                    <div class="guideline-section">
                        <h4>×•×•×œ×™×•× ×•-Headroom</h4>
                        <ul>
                            <li><strong>×œ× ×œ××§×¡ ×—×œ×© ××“×™!</strong> ×¨××” × ××•×›×” ××“×™ ××‘×–×‘×–×ª ×¨×–×•×œ×•×¦×™×™×ª ×‘×™×˜×™× - ×©××¨×• ×¢×œ ×¨××•×ª ×‘×¨×™××•×ª</li>
                            <li>×‘××™×§×¡ ×¢××•×¡ ×–×” ×‘×¡×“×¨ ×’××•×¨ ×œ×”×ª×§×¨×‘ ×œ-0dB - ×›×œ ×¢×•×“ ××™×Ÿ ×§×œ×™×¤×™× ×’</li>
                            <li>×œ× ×—×™×™×‘×™× ×‘×“×™×•×§ -6dB - ×¤×©×•×˜ ×”×™×× ×¢×• ××§×œ×™×¤×™× ×’</li>
                            <li>×œ×œ× Limiter/Maximizer ×¢×œ ×”-Clean Mix</li>
                        </ul>
                    </div>
                    <div class="guideline-section">
                        <h4>××” ×œ× ×œ×¢×©×•×ª</h4>
                        <ul>
                            <li>×œ× ×œ×©× ×•×ª Sample Rate</li>
                            <li>×œ× ×œ×¢×©×•×ª Normalizing</li>
                            <li>×œ× ×œ×¢×©×•×ª SRC/Resampling</li>
                            <li>×œ× ×œ×”×•×¡×™×£ ×¢×™×‘×•×“×™× ×¢×œ Mix Bus ×‘×’×¨×¡×” ×”× ×§×™×™×”</li>
                        </ul>
                    </div>
                    <div class="guideline-section">
                        <h4>×©××•×ª ×§×‘×¦×™×</h4>
                        <ul>
                            <li>Artist â€“ Track â€“ MIX</li>
                            <li>Artist â€“ Track â€“ MASTER REF</li>
                            <li>×¤×•×¨××˜: WAV ××• AIFF ×‘×œ×‘×“</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸµ</div>
            <div class="upload-text" data-en="Drop file here or click to browse" data-he="×’×¨×•×¨ ×§×•×‘×¥ ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”"></div>
            <div class="upload-formats">WAV, AIFF, MP3, FLAC â€¢ Max 200MB</div>
        </div>
        <input type="file" id="fileInput" accept="audio/*">

        <!-- File Info -->
        <div class="file-info" id="fileInfo">
            <div class="file-name" id="fileName"></div>
            <div class="file-meta" id="fileMeta"></div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div data-en="Analyzing mix..." data-he="×× ×ª×— ××ª ×”××™×§×¡..."></div>
        </div>

        <!-- Results -->
        <div class="results" id="results">
            <!-- Status Card -->
            <div class="status-card" id="statusCard">
                <div class="status-icon" id="statusIcon">âœ…</div>
                <div class="status-title" id="statusTitle"></div>
                <div class="status-desc" id="statusDesc"></div>
            </div>

            <!-- Checklist -->
            <div class="checklist" id="checklist">
                <div class="checklist-title">ğŸ“‹ <span data-en="Quality Check" data-he="×‘×“×™×§×ª ×ª×§×™× ×•×ª"></span></div>
                <div id="checkItems"></div>
            </div>

            <!-- Issues -->
            <div class="issues-section" id="issuesSection">
                <div class="issues-title">âš ï¸ <span data-en="Issues Found" data-he="×‘×¢×™×•×ª ×©× ××¦××•"></span></div>
                <div id="issuesList"></div>
            </div>

            <!-- Instructions -->
            <div class="instructions" id="instructions">
                <div class="instructions-title">ğŸ“ <span data-en="How to Fix" data-he="×”× ×—×™×•×ª ×œ×ª×™×§×•×Ÿ"></span></div>
                <div id="instructionsList"></div>
            </div>

            <!-- Metrics Grid -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label" data-en="Peak Level" data-he="×¢×•×¦××ª Peak"></div>
                    <div class="metric-value" id="peakValue">-</div>
                    <div class="metric-status" id="peakStatus">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label" data-en="Average Level" data-he="×¢×•×¦××” ×××•×¦×¢×ª"></div>
                    <div class="metric-value" id="rmsValue">-</div>
                    <div class="metric-status" id="rmsStatus">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label" data-en="Dynamic Range" data-he="×˜×•×•×— ×“×™× ××™"></div>
                    <div class="metric-value" id="dynValue">-</div>
                    <div class="metric-status" id="dynStatus">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label" data-en="Stereo Width" data-he="×¨×•×—×‘ ×¡×˜×¨×™××•"></div>
                    <div class="metric-value" id="widthValue">-</div>
                    <div class="metric-status" id="widthStatus">-</div>
                </div>
                <div class="metric-card full">
                    <div class="metric-label" data-en="L/R Balance" data-he="××™×–×•×Ÿ L/R"></div>
                    <div class="metric-value" id="balanceValue">-</div>
                    <div class="metric-status" id="balanceStatus">-</div>
                </div>
            </div>

            <!-- Frequency Balance (3-band) -->
            <div class="freq-balance" id="freqBalance" style="display:none;">
                <div class="freq-title">ğŸšï¸ <span data-en="Frequency Balance" data-he="××™×–×•×Ÿ ×ª×“×¨×™×">Frequency Balance</span></div>
                <div class="freq-note" data-en="Energy distribution (octave-normalized)" data-he="×”×ª×¤×œ×’×•×ª ×× ×¨×’×™×” (×× ×•×¨××œ ×œ××•×§×˜×‘×•×ª)">Energy distribution (octave-normalized)</div>
                <div class="freq-3band">
                    <div class="freq-band">
                        <div class="freq-band-label" data-en="Low" data-he="× ××•×›×™×">Low</div>
                        <div class="freq-band-range">20-250Hz</div>
                        <div class="freq-band-bar-wrap">
                            <div class="freq-band-bar low" id="freqBarLow" style="width:0%"></div>
                        </div>
                        <div class="freq-band-value" id="freqValLow">-</div>
                    </div>
                    <div class="freq-band">
                        <div class="freq-band-label" data-en="Mid" data-he="×××¦×¢×™×™×">Mid</div>
                        <div class="freq-band-range">250Hz-4kHz</div>
                        <div class="freq-band-bar-wrap">
                            <div class="freq-band-bar mid" id="freqBarMid" style="width:0%"></div>
                        </div>
                        <div class="freq-band-value" id="freqValMid">-</div>
                    </div>
                    <div class="freq-band">
                        <div class="freq-band-label" data-en="High" data-he="×’×‘×•×”×™×">High</div>
                        <div class="freq-band-range">4-16kHz</div>
                        <div class="freq-band-bar-wrap">
                            <div class="freq-band-bar high" id="freqBarHigh" style="width:0%"></div>
                        </div>
                        <div class="freq-band-value" id="freqValHigh">-</div>
                    </div>
                </div>
                <div class="freq-reference" data-en="Typical mix: Low ~30-35%, Mid ~40-45%, High ~20-30%" data-he="××™×§×¡ ×˜×™×¤×•×¡×™: × ××•×›×™× ~30-35%, ×××¦×¢×™×™× ~40-45%, ×’×‘×•×”×™× ~20-30%">Typical mix: Low ~30-35%, Mid ~40-45%, High ~20-30%</div>
            </div>

            <!-- Live Spectrum -->
            <div class="spectrum" id="spectrum">
                <div class="spectrum-title">
                    <span data-en="Live Spectrum" data-he="×¡×¤×§×˜×¨×•× ×—×™"></span>
                    <span class="live-badge" id="liveBadge" style="display:none;">Live</span>
                </div>
                <div class="spectrum-bars" id="bars"></div>
                <div class="spectrum-labels">
                    <span>Sub</span>
                    <span>Bass</span>
                    <span>Low Mid</span>
                    <span>Mid</span>
                    <span>High Mid</span>
                    <span>Air</span>
                </div>
            </div>

            <!-- Player -->
            <div class="player" id="player">
                <div class="player-controls">
                    <button class="play-btn" id="playBtn">â–¶</button>
                    <div class="player-info">
                        <div class="player-time">
                            <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="pdf-btn" id="pdfBtn">
                    <span class="btn-icon">ğŸ“„</span>
                    <span class="btn-text" data-en="Download PDF Report" data-he="×”×•×¨×“ ×“×•×´×— PDF">Download PDF Report</span>
                </button>
                <button class="reset-btn" id="resetBtn">
                    <span class="btn-icon">ğŸ”„</span>
                    <span class="btn-text" data-en="Check Another File" data-he="×‘×“×•×§ ×§×•×‘×¥ × ×•×¡×£">Check Another File</span>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <a href="https://guyshema.com" target="_blank">guyshema.com</a><br>
            Guy Shema Oppenheimer Â© 2025
        </div>
    </div>

    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // ========== LANGUAGE SYSTEM ==========
        let currentLang = 'en';
        
        const texts = {
            en: {
                // Status
                ready_title: 'Mix is Ready!',
                ready_desc: 'Good to send for mastering',
                warning_title: 'Some Things to Check',
                warning_desc: 'Can send, but review the notes below',
                issues_title: 'Issues to Fix',
                issues_desc: 'Please fix these issues before sending',
                
                // Checklist
                check_clipping: 'No digital clipping',
                check_phase: 'Mono compatibility (phase)',
                check_balance: 'L/R Balance',
                check_dynamics: 'Dynamic Range',
                check_width: 'Stereo Width',
                
                // Metric status
                ok: 'OK',
                good: 'Good',
                high: 'High',
                clipping: 'Clipping!',
                weak: 'Weak',
                strong: 'Strong',
                compressed: 'Compressed',
                very_dynamic: 'Very Dynamic',
                narrow: 'Narrow',
                wide: 'Wide',
                centered: 'Centered',
                balanced: 'Balanced',
                unbalanced: 'Unbalanced',
                
                // Issues
                issue_clipping: 'Digital Clipping!',
                issue_clipping_desc: 'Samples are hitting 0dBFS or above. This will cause distortion.',
                issue_phase_severe: 'Severe Phase Issues!',
                issue_phase_severe_desc: 'Elements will cancel in mono.',
                issue_phase_warn: 'Possible Phase Issues',
                issue_phase_warn_desc: 'Negative correlation. Check mono compatibility.',
                issue_balance: 'Asymmetric Balance',
                issue_balance_desc: 'Mix leans to one side.',
                issue_quiet: 'Very Low Level',
                issue_quiet_desc: 'Mix is very quiet. Make sure this is intentional.',
                issue_crushed: 'Over-Compressed',
                issue_crushed_desc: 'Almost no dynamic range. If using a limiter, send version without it.',
                issue_wide: 'Too Wide',
                issue_wide_desc: 'Extreme stereo width may cause issues.',
                issue_dc_offset: 'DC Offset Detected',
                issue_dc_offset_desc: 'Low frequency bias in the signal. May cause clicks or asymmetric headroom.',
                
                // Instructions
                inst_clipping: 'Lower the Mix Bus or Master Fader so peaks don\'t hit 0dB',
                inst_limiter: 'If there\'s a Limiter on the master, send a clean version without it',
                inst_phase: 'Check mix in mono - look for Stereo Wideners or Chorus causing phase cancellation',
                inst_sample_rate: 'Export at the project\'s original Sample Rate',
                inst_naming: 'File names: Artist â€“ Track â€“ MIX / Artist â€“ Track â€“ MASTER REF',
                
                // Correlation
                correlation: 'corr'
            },
            he: {
                // Status
                ready_title: '×”××™×§×¡ ××•×›×Ÿ!',
                ready_desc: '××¤×©×¨ ×œ×©×œ×•×— ×œ×××¡×˜×¨×™× ×’',
                warning_title: '×™×© ×“×‘×¨×™× ×œ×‘×“×•×§',
                warning_desc: '××¤×©×¨ ×œ×©×œ×•×—, ××‘×œ ×›×“××™ ×œ×‘×“×•×§ ××ª ×”×”×¢×¨×•×ª',
                issues_title: '×™×© ×‘×¢×™×•×ª ×œ×ª×§×Ÿ',
                issues_desc: '× × ×œ×ª×§×Ÿ ××ª ×”×‘×¢×™×•×ª ×œ×¤× ×™ ×©×œ×™×—×” ×œ×××¡×˜×¨×™× ×’',
                
                // Checklist
                check_clipping: '×œ×œ× ×§×œ×™×¤×™× ×’ ×“×™×’×™×˜×œ×™',
                check_phase: '×ª××™××•×ª ××•× ×• (×¤××–×”)',
                check_balance: '××™×–×•×Ÿ L/R',
                check_dynamics: '×˜×•×•×— ×“×™× ××™',
                check_width: '×¨×•×—×‘ ×¡×˜×¨×™××•',
                
                // Metric status
                ok: '×ª×§×™×Ÿ',
                good: '×˜×•×‘',
                high: '×’×‘×•×”',
                clipping: '×§×œ×™×¤×™× ×’!',
                weak: '×—×œ×©',
                strong: '×—×–×§',
                compressed: '×“×—×•×¡',
                very_dynamic: '×“×™× ××™ ×××•×“',
                narrow: '×¦×¨',
                wide: '×¨×—×‘',
                centered: '××¨×›×–',
                balanced: '×××•×–×Ÿ',
                unbalanced: '×œ× ×¡×™××˜×¨×™',
                
                // Issues
                issue_clipping: '×§×œ×™×¤×™× ×’ ×“×™×’×™×˜×œ×™!',
                issue_clipping_desc: '×™×© ×“×’×™××•×ª ×©××’×™×¢×•×ª ×œ-0dBFS ××• ××¢×‘×¨. ×–×” ×™×’×¨×•× ×œ×¢×™×•×•×ª.',
                issue_phase_severe: '×‘×¢×™×™×ª ×¤××–×” ×—××•×¨×”!',
                issue_phase_severe_desc: '××œ×× ×˜×™× ×™×ª×‘×˜×œ×• ×‘××•× ×•.',
                issue_phase_warn: '×‘×¢×™×™×ª ×¤××–×” ××¤×©×¨×™×ª',
                issue_phase_warn_desc: '×§×•×¨×œ×¦×™×” ×©×œ×™×œ×™×ª. ×›×“××™ ×œ×‘×“×•×§ ××•× ×•.',
                issue_balance: '××™×–×•×Ÿ ×œ× ×¡×™××˜×¨×™',
                issue_balance_desc: '×”××™×§×¡ × ×•×˜×” ×œ×¦×“ ××—×“.',
                issue_quiet: '×¢×•×¦××” × ××•×›×” ×××•×“',
                issue_quiet_desc: '×”××™×§×¡ ×—×œ×© ×××•×“. ×•×•×“××• ×©×–×” ××›×•×•×Ÿ ×•×œ× ×˜×¢×•×ª ×‘×™×¦×•×.',
                issue_crushed: '×“×—×•×¡ ××“×™',
                issue_crushed_desc: '×›××¢×˜ ××™×Ÿ ×˜×•×•×— ×“×™× ××™. ×× ×™×© ×œ×™××™×˜×¨ - ×©×œ×—×• ×’×¨×¡×” ×‘×œ×¢×“×™×•.',
                issue_wide: '×¨×—×‘ ××“×™',
                issue_wide_desc: '×¨×•×—×‘ ×¡×˜×¨×™××• ×§×™×¦×•× ×™ ×¢×œ×•×œ ×œ×’×¨×•× ×œ×‘×¢×™×•×ª.',
                issue_dc_offset: '×–×•×”×” DC Offset',
                issue_dc_offset_desc: '×”×˜×™×” ×‘×ª×“×¨ × ××•×š ×‘××•×ª. ×¢×œ×•×œ ×œ×’×¨×•× ×œ×§×œ×™×§×™× ××• ×—×•×¡×¨ ×¡×™××˜×¨×™×” ×‘-headroom.',
                
                // Instructions
                inst_clipping: '×”×•×¨×™×“×• ××ª ×¢×•×¦××ª ×”-Mix Bus ××• Master Fader ×›×š ×©×”×¤×™×§×™× ×œ× ×™×’×¢×• ×‘-0dB',
                inst_limiter: '×× ×™×© Limiter ×¢×œ ×”×××¡×˜×¨ - ×©×œ×—×• ×’×¨×¡×” × ×§×™×™×” ×‘×œ×¢×“×™×•',
                inst_phase: '×‘×“×§×• ××ª ×”××™×§×¡ ×‘××•× ×• - ×—×¤×©×• Stereo Wideners ××• Chorus ×©×’×•×¨××™× ×œ×‘×™×˜×•×œ×™ ×¤××–×”',
                inst_sample_rate: '×™×™×¦××• ×‘-Sample Rate ×”××§×•×¨×™ ×©×œ ×”×¤×¨×•×™×§×˜',
                inst_naming: '×©××•×ª ×§×‘×¦×™×: Artist â€“ Track â€“ MIX / Artist â€“ Track â€“ MASTER REF',
                
                // Correlation
                correlation: '×§×•×¨×œ×¦×™×”'
            }
        };

        function setLang(lang) {
            currentLang = lang;
            
            // Update buttons
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            document.getElementById('langHe').classList.toggle('active', lang === 'he');
            
            // Update RTL
            document.body.classList.toggle('rtl', lang === 'he');
            
            // Update all data-en/data-he elements
            document.querySelectorAll('[data-en]').forEach(el => {
                el.textContent = el.getAttribute('data-' + lang);
            });
            
            // Update guidelines content
            document.querySelectorAll('.lang-content').forEach(el => {
                el.style.display = el.getAttribute('data-lang') === lang ? 'block' : 'none';
            });
            
            // Re-render results if we have them
            if (window.lastAnalysis) {
                showResults(window.lastAnalysis);
            }
        }

        function t(key) {
            return texts[currentLang][key] || key;
        }

        // ========== AUDIO ANALYSIS ==========
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');

        let audioCtx = null;
        let buffer = null;
        let source = null;
        let analyser = null;
        let isPlaying = false;
        let startTime = 0;
        let pauseTime = 0;
        let animId = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // Upload handlers
        uploadArea.addEventListener('click', () => {
            initAudio();
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            initAudio();
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('audio/') && !file.name.match(/\.(wav|aiff|aif|mp3|flac|m4a|ogg)$/i)) {
                alert(currentLang === 'he' ? '× × ×œ×‘×—×•×¨ ×§×•×‘×¥ ××•×“×™×•' : 'Please select an audio file');
                return;
            }

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileMeta').textContent = formatSize(file.size);
            fileInfo.classList.add('show');
            uploadArea.classList.add('has-file');

            loading.classList.add('show');
            results.classList.remove('show');

            const reader = new FileReader();
            reader.onload = function(e) {
                audioCtx.decodeAudioData(e.target.result,
                    async function(decodedBuffer) {
                        buffer = decodedBuffer;
                        const analysis = await analyzeAudio(buffer);
                        window.lastAnalysis = analysis;
                        loading.classList.remove('show');
                        showResults(analysis);
                    },
                    function(err) {
                        alert((currentLang === 'he' ? '×œ× × ×™×ª×Ÿ ×œ×§×¨×•× ××ª ×”×§×•×‘×¥: ' : 'Cannot read file: ') + err);
                        reset();
                    }
                );
            };
            reader.onerror = function() {
                alert(currentLang === 'he' ? '×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥' : 'Error reading file');
                reset();
            };
            reader.readAsArrayBuffer(file);
        }

        async function analyzeAudio(buf) {
            const left = buf.getChannelData(0);
            const right = buf.numberOfChannels > 1 ? buf.getChannelData(1) : left;
            const len = left.length;
            const sampleRate = buf.sampleRate;

            console.log(`Analyzing ${len} samples at ${sampleRate}Hz (${(len/sampleRate).toFixed(2)}s)`);

            // Single pass for: Peak, RMS, Correlation components, M/S, Clipping
            let peakL = 0, peakR = 0;
            let sumLsq = 0, sumRsq = 0;
            let sumLR = 0;  // For correlation
            let sumMid = 0, sumSide = 0;
            let clippedSamples = 0;
            let dcL = 0, dcR = 0;  // DC offset detection

            // Process ALL samples
            for (let i = 0; i < len; i++) {
                const l = left[i];
                const r = right[i];
                
                // Peak (absolute)
                const absL = Math.abs(l);
                const absR = Math.abs(r);
                if (absL > peakL) peakL = absL;
                if (absR > peakR) peakR = absR;
                
                // RMS components
                sumLsq += l * l;
                sumRsq += r * r;
                
                // Correlation component
                sumLR += l * r;
                
                // M/S
                const mid = (l + r) * 0.5;
                const side = (l - r) * 0.5;
                sumMid += mid * mid;
                sumSide += side * side;
                
                // DC offset
                dcL += l;
                dcR += r;
                
                // Clipping (samples at or very near max)
                if (absL >= 0.9999 || absR >= 0.9999) {
                    clippedSamples++;
                }
            }

            // Calculate final values
            const peak = Math.max(peakL, peakR);
            const peakDb = 20 * Math.log10(peak || 1e-10);
            
            const rmsL = Math.sqrt(sumLsq / len);
            const rmsR = Math.sqrt(sumRsq / len);
            const rmsDbL = 20 * Math.log10(rmsL || 1e-10);
            const rmsDbR = 20 * Math.log10(rmsR || 1e-10);
            // Average of L/R in dB (standard metering approach)
            const rmsDb = (rmsDbL + rmsDbR) / 2;
            
            const crest = peakDb - rmsDb;

            // Correlation: Pearson coefficient
            // r = Î£(L*R) / sqrt(Î£(LÂ²) * Î£(RÂ²))
            const corrDenom = Math.sqrt(sumLsq * sumRsq);
            const correlation = corrDenom > 1e-10 ? sumLR / corrDenom : 1;

            // Stereo Width (Side/Mid ratio in dB, converted to %)
            const rmsMid = Math.sqrt(sumMid / len);
            const rmsSide = Math.sqrt(sumSide / len);
            let width = 0;
            if (rmsMid > 1e-10) {
                // 0% = mono (no side), 100% = equal M/S
                width = (rmsSide / rmsMid) * 100;
            }

            // L/R Balance in dB
            const balanceDb = 20 * Math.log10((rmsR || 1e-10) / (rmsL || 1e-10));

            // DC Offset
            const dcOffsetL = dcL / len;
            const dcOffsetR = dcR / len;

            // Dynamic Range: analyze loudness over time windows
            const drWindowMs = 400;  // 400ms windows
            const drWindowSize = Math.floor(sampleRate * drWindowMs / 1000);
            const drWindowCount = Math.floor(len / drWindowSize);
            const windowLoudness = [];

            for (let w = 0; w < drWindowCount; w++) {
                let windowSum = 0;
                const start = w * drWindowSize;
                for (let i = 0; i < drWindowSize; i++) {
                    const idx = start + i;
                    const mono = (left[idx] + right[idx]) * 0.5;
                    windowSum += mono * mono;
                }
                const windowRms = Math.sqrt(windowSum / drWindowSize);
                if (windowRms > 1e-10) {
                    windowLoudness.push(20 * Math.log10(windowRms));
                }
            }

            let dynamicRange = crest;
            if (windowLoudness.length > 10) {
                windowLoudness.sort((a, b) => a - b);
                const lowIdx = Math.floor(windowLoudness.length * 0.1);
                const highIdx = Math.floor(windowLoudness.length * 0.95);
                const low = windowLoudness[lowIdx];
                const high = windowLoudness[highIdx];
                dynamicRange = Math.max(0, high - low);
            }

            // Log results for verification
            console.log('=== Analysis Results ===');
            console.log(`Peak: ${peakDb.toFixed(2)} dBFS (L: ${(20*Math.log10(peakL||1e-10)).toFixed(2)}, R: ${(20*Math.log10(peakR||1e-10)).toFixed(2)})`);
            console.log(`RMS: ${rmsDb.toFixed(2)} dBFS (L: ${rmsDbL.toFixed(2)}, R: ${rmsDbR.toFixed(2)})`);
            console.log(`Crest Factor: ${crest.toFixed(2)} dB`);
            console.log(`Dynamic Range: ${dynamicRange.toFixed(2)} dB`);
            console.log(`Correlation: ${correlation.toFixed(3)}`);
            console.log(`Stereo Width: ${width.toFixed(1)}%`);
            console.log(`L/R Balance: ${balanceDb.toFixed(2)} dB`);
            console.log(`Clipped Samples: ${clippedSamples} (${(clippedSamples/len*100).toFixed(4)}%)`);
            console.log(`DC Offset: L=${(dcOffsetL*100).toFixed(4)}%, R=${(dcOffsetR*100).toFixed(4)}%`);
            console.log('========================');

            // Issues detection
            const issues = [];
            // Clipping: peak at or above -0.1dB, or many samples at max
            const hasClipping = peakDb >= -0.1 || clippedSamples > Math.floor(sampleRate * 0.001);
            
            if (hasClipping) {
                issues.push({ id: 'clipping', severity: 'bad' });
            }

            if (correlation < -0.2) {
                issues.push({ id: 'phase_severe', severity: 'bad', correlation });
            } else if (correlation < 0) {
                issues.push({ id: 'phase_warn', severity: 'warn', correlation });
            }

            if (Math.abs(balanceDb) > 2) {
                issues.push({ id: 'balance', severity: 'warn', balanceDb });
            }

            if (peakDb < -12) {
                issues.push({ id: 'quiet', severity: 'warn' });
            }

            if (crest < 4 && peakDb > -6) {
                issues.push({ id: 'crushed', severity: 'warn' });
            }

            if (width > 150) {
                issues.push({ id: 'wide', severity: 'warn' });
            }

            // DC offset warning
            if (Math.abs(dcOffsetL) > 0.001 || Math.abs(dcOffsetR) > 0.001) {
                issues.push({ id: 'dc_offset', severity: 'warn' });
            }

            // Simple 3-band spectral analysis (Low/Mid/High)
            // Using Goertzel algorithm for specific frequency bands
            const spectrum = analyzeSpectrum3Band(left, right, len, sampleRate);

            return {
                peakDb, rmsDb, crest, dynamicRange, width, correlation, balanceDb,
                hasClipping, clippedSamples, issues, spectrum,
                peakL: 20 * Math.log10(peakL || 1e-10),
                peakR: 20 * Math.log10(peakR || 1e-10),
                duration: buf.duration, sampleRate: buf.sampleRate, channels: buf.numberOfChannels
            };
        }

        // 3-Band Spectrum Analysis with octave normalization
        function analyzeSpectrum3Band(left, right, len, sampleRate) {
            // Band definitions (musical ranges)
            // Low: 20-250Hz (~3.6 octaves) - Bass, Sub
            // Mid: 250-4000Hz (~4 octaves) - Vocals, instruments body
            // High: 4000-16000Hz (~2 octaves) - Air, brilliance
            
            const bands = [
                { name: 'low', minHz: 20, maxHz: 250, testFreqs: [40, 80, 125, 200] },
                { name: 'mid', minHz: 250, maxHz: 4000, testFreqs: [400, 800, 1600, 2500, 3500] },
                { name: 'high', minHz: 4000, maxHz: Math.min(16000, sampleRate/2 - 1000), testFreqs: [5000, 8000, 12000] }
            ];
            
            // Calculate octaves for each band
            bands.forEach(b => {
                b.octaves = Math.log2(b.maxHz / b.minHz);
            });
            
            const blockSize = 4096;
            const numBlocks = Math.min(50, Math.floor(len / blockSize));
            if (numBlocks < 1) return null;
            
            const bandEnergy = { low: 0, mid: 0, high: 0 };
            
            // Process blocks across the track
            for (let block = 0; block < numBlocks; block++) {
                const startIdx = Math.floor((block / numBlocks) * (len - blockSize));
                
                // Prepare mono signal with Hanning window
                const signal = new Float32Array(blockSize);
                for (let i = 0; i < blockSize; i++) {
                    const mono = (left[startIdx + i] + right[startIdx + i]) * 0.5;
                    const window = 0.5 * (1 - Math.cos(2 * Math.PI * i / blockSize));
                    signal[i] = mono * window;
                }
                
                // Goertzel for each test frequency
                for (const band of bands) {
                    let bandSum = 0;
                    for (const freq of band.testFreqs) {
                        if (freq >= sampleRate / 2) continue;
                        
                        const k = Math.round(freq * blockSize / sampleRate);
                        const w = 2 * Math.PI * k / blockSize;
                        const coeff = 2 * Math.cos(w);
                        
                        let s1 = 0, s2 = 0;
                        for (let i = 0; i < blockSize; i++) {
                            const s0 = signal[i] + coeff * s1 - s2;
                            s2 = s1;
                            s1 = s0;
                        }
                        
                        const mag = Math.sqrt(s1*s1 + s2*s2 - coeff*s1*s2) / blockSize;
                        bandSum += mag * mag;  // Energy
                    }
                    bandEnergy[band.name] += bandSum / band.testFreqs.length;
                }
            }
            
            // Average over blocks
            bandEnergy.low /= numBlocks;
            bandEnergy.mid /= numBlocks;
            bandEnergy.high /= numBlocks;
            
            // Normalize by octaves (wider bands have more energy naturally)
            const normLow = bandEnergy.low / bands[0].octaves;
            const normMid = bandEnergy.mid / bands[1].octaves;
            const normHigh = bandEnergy.high / bands[2].octaves;
            
            // Calculate percentages
            const total = normLow + normMid + normHigh;
            if (total < 1e-10) return null;
            
            const result = {
                low: (normLow / total) * 100,
                mid: (normMid / total) * 100,
                high: (normHigh / total) * 100
            };
            
            // Reference: typical balanced mix has roughly 30-35% low, 40-45% mid, 20-30% high
            // After octave normalization
            console.log('=== Spectrum Balance ===');
            console.log(`Low (20-250Hz): ${result.low.toFixed(1)}%`);
            console.log(`Mid (250-4kHz): ${result.mid.toFixed(1)}%`);
            console.log(`High (4-16kHz): ${result.high.toFixed(1)}%`);
            console.log('Reference: Low ~30-35%, Mid ~40-45%, High ~20-30%');
            console.log('========================');
            
            return result;
        }

        function showResults(r) {
            results.classList.add('show');

            const hasBadIssues = r.issues.some(i => i.severity === 'bad');
            const hasWarnIssues = r.issues.some(i => i.severity === 'warn');

            const statusCard = document.getElementById('statusCard');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusDesc = document.getElementById('statusDesc');

            if (hasBadIssues) {
                statusCard.className = 'status-card issues';
                statusIcon.textContent = 'âŒ';
                statusTitle.textContent = t('issues_title');
                statusDesc.textContent = t('issues_desc');
            } else if (hasWarnIssues) {
                statusCard.className = 'status-card warning';
                statusIcon.textContent = 'âš ï¸';
                statusTitle.textContent = t('warning_title');
                statusDesc.textContent = t('warning_desc');
            } else {
                statusCard.className = 'status-card ready';
                statusIcon.textContent = 'âœ…';
                statusTitle.textContent = t('ready_title');
                statusDesc.textContent = t('ready_desc');
            }

            // Checklist
            const checkItems = document.getElementById('checkItems');
            const hasClippingIssue = r.hasClipping || r.peakDb >= -0.1;
            const peakOk = r.peakDb < -0.1;  // True Peak should be below -0.1dB for safety
            const phaseOk = r.correlation >= 0;
            const balanceOk = Math.abs(r.balanceDb) <= 1.5;
            const dynOk = r.crest >= 4;
            const widthOk = r.width <= 80 && r.width >= 10;

            checkItems.innerHTML = `
                <div class="check-item">
                    <div class="check-icon ${peakOk ? 'pass' : 'fail'}">${peakOk ? 'âœ“' : 'âœ—'}</div>
                    <div class="check-text">${t('check_clipping')}</div>
                    <div class="check-value">${r.peakDb.toFixed(1)} dB</div>
                </div>
                <div class="check-item">
                    <div class="check-icon ${r.correlation >= 0.3 ? 'pass' : (phaseOk ? 'warn' : 'fail')}">${r.correlation >= 0.3 ? 'âœ“' : (phaseOk ? '!' : 'âœ—')}</div>
                    <div class="check-text">${t('check_phase')}</div>
                    <div class="check-value">${r.correlation.toFixed(2)}</div>
                </div>
                <div class="check-item">
                    <div class="check-icon ${balanceOk ? 'pass' : 'warn'}">${balanceOk ? 'âœ“' : '!'}</div>
                    <div class="check-text">${t('check_balance')}</div>
                    <div class="check-value">${Math.abs(r.balanceDb) < 0.5 ? t('balanced') : (r.balanceDb > 0 ? 'R' : 'L') + ' +' + Math.abs(r.balanceDb).toFixed(1) + 'dB'}</div>
                </div>
                <div class="check-item">
                    <div class="check-icon ${dynOk ? 'pass' : 'warn'}">${dynOk ? 'âœ“' : '!'}</div>
                    <div class="check-text">${t('check_dynamics')}</div>
                    <div class="check-value">${r.crest.toFixed(1)} dB</div>
                </div>
                <div class="check-item">
                    <div class="check-icon ${widthOk ? 'pass' : 'warn'}">${widthOk ? 'âœ“' : '!'}</div>
                    <div class="check-text">${t('check_width')}</div>
                    <div class="check-value">${r.width.toFixed(0)}%</div>
                </div>
            `;

            // Issues section
            const issuesSection = document.getElementById('issuesSection');
            const issuesList = document.getElementById('issuesList');

            if (r.issues.length > 0) {
                issuesSection.classList.add('show');
                issuesList.innerHTML = r.issues.map(issue => {
                    let name, desc;
                    if (issue.id === 'clipping') {
                        name = t('issue_clipping');
                        desc = t('issue_clipping_desc');
                    } else if (issue.id === 'phase_severe') {
                        name = t('issue_phase_severe');
                        desc = `${t('correlation')}: ${issue.correlation.toFixed(2)}. ${t('issue_phase_severe_desc')}`;
                    } else if (issue.id === 'phase_warn') {
                        name = t('issue_phase_warn');
                        desc = `${t('correlation')}: ${issue.correlation.toFixed(2)}. ${t('issue_phase_warn_desc')}`;
                    } else if (issue.id === 'balance') {
                        name = t('issue_balance');
                        desc = `${t('issue_balance_desc')} ${Math.abs(issue.balanceDb).toFixed(1)}dB ${issue.balanceDb > 0 ? (currentLang === 'he' ? '×œ×™××™×Ÿ' : 'right') : (currentLang === 'he' ? '×œ×©×××œ' : 'left')}.`;
                    } else if (issue.id === 'quiet') {
                        name = t('issue_quiet');
                        desc = t('issue_quiet_desc');
                    } else if (issue.id === 'crushed') {
                        name = t('issue_crushed');
                        desc = t('issue_crushed_desc');
                    } else if (issue.id === 'wide') {
                        name = t('issue_wide');
                        desc = t('issue_wide_desc');
                    }
                    return `<div class="issue-item"><div class="issue-name">${name}</div><div class="issue-desc">${desc}</div></div>`;
                }).join('');
            } else {
                issuesSection.classList.remove('show');
            }

            // Instructions
            const instructions = document.getElementById('instructions');
            const instructionsList = document.getElementById('instructionsList');

            if (r.issues.length > 0 || r.crest < 6) {
                instructions.style.display = 'block';
                let instHtml = '';
                let instNum = 1;

                if (r.hasClipping) {
                    instHtml += `<div class="instruction-item"><div class="instruction-num">${instNum++}</div><div>${t('inst_clipping')}</div></div>`;
                }
                if (r.crest < 5) {
                    instHtml += `<div class="instruction-item"><div class="instruction-num">${instNum++}</div><div>${t('inst_limiter')}</div></div>`;
                }
                if (r.issues.some(i => i.id.includes('phase'))) {
                    instHtml += `<div class="instruction-item"><div class="instruction-num">${instNum++}</div><div>${t('inst_phase')}</div></div>`;
                }
                instHtml += `<div class="instruction-item"><div class="instruction-num">${instNum++}</div><div>${t('inst_sample_rate')} (${r.sampleRate}Hz âœ“)</div></div>`;
                instHtml += `<div class="instruction-item"><div class="instruction-num">${instNum++}</div><div>${t('inst_naming')}</div></div>`;

                instructionsList.innerHTML = instHtml;
            } else {
                instructions.style.display = 'none';
            }

            // Metrics
            document.getElementById('peakValue').textContent = r.peakDb.toFixed(1) + ' dB';
            document.getElementById('peakStatus').textContent = r.peakDb < -1 ? t('ok') : (r.peakDb < -0.1 ? t('high') : t('clipping'));
            document.getElementById('peakStatus').className = 'metric-status ' + (r.peakDb < -1 ? 'good' : (r.peakDb < -0.1 ? 'warn' : 'bad'));

            document.getElementById('rmsValue').textContent = r.rmsDb.toFixed(1) + ' dB';
            document.getElementById('rmsStatus').textContent = r.rmsDb < -20 ? t('weak') : (r.rmsDb < -6 ? t('ok') : t('strong'));
            document.getElementById('rmsStatus').className = 'metric-status ' + (r.rmsDb < -20 ? 'warn' : 'good');

            document.getElementById('dynValue').textContent = r.crest.toFixed(1) + ' dB';
            document.getElementById('dynStatus').textContent = r.crest < 4 ? t('compressed') : (r.crest > 16 ? t('very_dynamic') : t('ok'));
            document.getElementById('dynStatus').className = 'metric-status ' + (r.crest < 4 ? 'warn' : 'good');

            document.getElementById('widthValue').textContent = r.width.toFixed(0) + '%';
            document.getElementById('widthStatus').textContent = r.width < 20 ? t('narrow') : (r.width > 70 ? t('wide') : t('ok'));
            document.getElementById('widthStatus').className = 'metric-status ' + (r.width > 80 || r.width < 10 ? 'warn' : 'good');

            document.getElementById('balanceValue').textContent = Math.abs(r.balanceDb) < 0.5 ? t('centered') : (r.balanceDb > 0 ? 'R' : 'L') + ' +' + Math.abs(r.balanceDb).toFixed(1) + 'dB';
            document.getElementById('balanceStatus').textContent = Math.abs(r.balanceDb) < 1 ? t('balanced') : t('unbalanced');
            document.getElementById('balanceStatus').className = 'metric-status ' + (Math.abs(r.balanceDb) < 1.5 ? 'good' : 'warn');

            // 3-Band Frequency Balance
            if (r.spectrum) {
                document.getElementById('freqBarLow').style.width = r.spectrum.low + '%';
                document.getElementById('freqBarMid').style.width = r.spectrum.mid + '%';
                document.getElementById('freqBarHigh').style.width = r.spectrum.high + '%';
                document.getElementById('freqValLow').textContent = r.spectrum.low.toFixed(0) + '%';
                document.getElementById('freqValMid').textContent = r.spectrum.mid.toFixed(0) + '%';
                document.getElementById('freqValHigh').textContent = r.spectrum.high.toFixed(0) + '%';
                document.getElementById('freqBalance').style.display = 'block';
            } else {
                document.getElementById('freqBalance').style.display = 'none';
            }

            // Player
            document.getElementById('player').classList.add('show');
            document.getElementById('totalTime').textContent = formatTime(r.duration);

            initSpectrumBars();
        }

        function initSpectrumBars() {
            const bars = document.getElementById('bars');
            bars.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const bar = document.createElement('div');
                bar.className = 'spectrum-bar';
                bar.style.height = '4px';
                bars.appendChild(bar);
            }
        }

        // Player
        const playBtn = document.getElementById('playBtn');
        playBtn.addEventListener('click', togglePlay);

        function togglePlay() {
            if (isPlaying) stopAudio();
            else playAudio();
        }

        function playAudio() {
            if (!buffer) return;

            source = audioCtx.createBufferSource();
            source.buffer = buffer;

            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;

            source.connect(analyser);
            analyser.connect(audioCtx.destination);

            source.start(0, pauseTime);
            startTime = audioCtx.currentTime - pauseTime;
            isPlaying = true;
            playBtn.textContent = 'â¸';
            document.getElementById('liveBadge').style.display = 'inline';

            source.onended = () => {
                if (isPlaying) {
                    stopAudio();
                    pauseTime = 0;
                }
            };

            updateSpectrum();
        }

        function stopAudio() {
            if (source) {
                source.stop();
                source.disconnect();
            }
            pauseTime = audioCtx.currentTime - startTime;
            if (pauseTime >= buffer.duration) pauseTime = 0;
            isPlaying = false;
            playBtn.textContent = 'â–¶';
            document.getElementById('liveBadge').style.display = 'none';
            if (animId) cancelAnimationFrame(animId);
        }

        function updateSpectrum() {
            if (!isPlaying || !analyser) return;

            const freqData = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(freqData);

            const bars = document.querySelectorAll('.spectrum-bar');
            const step = Math.floor(freqData.length / bars.length);

            bars.forEach((bar, i) => {
                const value = freqData[i * step];
                const height = Math.max(4, (value / 255) * 80);
                bar.style.height = height + 'px';
            });

            const elapsed = audioCtx.currentTime - startTime;
            document.getElementById('currentTime').textContent = formatTime(elapsed);
            document.getElementById('progressFill').style.width = (elapsed / buffer.duration * 100) + '%';

            animId = requestAnimationFrame(updateSpectrum);
        }

        // Reset
        document.getElementById('resetBtn').addEventListener('click', reset);

        // PDF Download
        document.getElementById('pdfBtn').addEventListener('click', generatePDF);

        function generatePDF() {
            if (!window.lastAnalysis) return;
            
            const r = window.lastAnalysis;
            const fileName = document.getElementById('fileName').textContent || 'audio-file';
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const gold = [201, 162, 39];
            const dark = [26, 26, 46];
            const white = [244, 244, 245];
            const gray = [113, 113, 122];
            
            // Header background
            doc.setFillColor(...dark);
            doc.rect(0, 0, 210, 50, 'F');
            
            // Logo - oppenmasters as styled text
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            // Draw "oppen" in white
            doc.setTextColor(...white);
            doc.text('oppen', 20, 28);
            // Draw "masters" in gold right after (measure oppen width)
            const oppenWidth = doc.getTextWidth('oppen');
            doc.setTextColor(...gold);
            doc.text('masters', 20 + oppenWidth, 28);
            
            // Subtitle
            doc.setTextColor(...gray);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Pre-Mastering Mix Analysis Report', 20, 38);
            
            // File info
            doc.setTextColor(...dark);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('File: ' + fileName, 20, 60);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...gray);
            const dateStr = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            doc.text('Generated: ' + dateStr, 20, 68);
            doc.text('Duration: ' + formatTime(r.duration) + ' | Sample Rate: ' + formatSampleRate(r.sampleRate) + ' | Channels: ' + r.channels, 20, 74);
            
            // Status
            let y = 88;
            const hasBadIssues = r.issues.some(i => i.severity === 'bad');
            const hasWarnIssues = r.issues.some(i => i.severity === 'warn');
            
            doc.setFillColor(...(hasBadIssues ? [239, 68, 68] : (hasWarnIssues ? [245, 158, 11] : [34, 197, 94])));
            doc.roundedRect(20, y, 170, 20, 3, 3, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            const statusText = hasBadIssues ? 'Issues Found - Needs Attention' : (hasWarnIssues ? 'Minor Issues - Review Recommended' : 'Mix is Ready for Mastering');
            doc.text(statusText, 105, y + 13, { align: 'center' });
            
            // Metrics section
            y = 118;
            doc.setTextColor(...dark);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Audio Metrics', 20, y);
            
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            const metrics = [
                ['Peak Level', r.peakDb.toFixed(1) + ' dB', r.peakDb < -1 ? 'OK' : (r.peakDb < 0 ? 'High' : 'Clipping!')],
                ['Average Level (RMS)', r.rmsDb.toFixed(1) + ' dB', r.rmsDb < -20 ? 'Quiet' : 'OK'],
                ['Dynamic Range', r.crest.toFixed(1) + ' dB', r.crest < 4 ? 'Compressed' : (r.crest > 16 ? 'Very Dynamic' : 'OK')],
                ['Stereo Width', r.width.toFixed(0) + '%', r.width > 80 ? 'Very Wide' : 'OK'],
                ['Mono Correlation', r.correlation.toFixed(2), r.correlation < 0 ? 'Phase Issues!' : 'OK'],
                ['L/R Balance', (r.balanceDb > 0 ? '+' : '') + r.balanceDb.toFixed(1) + ' dB', Math.abs(r.balanceDb) > 2 ? 'Unbalanced' : 'OK']
            ];
            
            metrics.forEach((m, i) => {
                const rowY = y + (i * 8);
                doc.setTextColor(...gray);
                doc.text(m[0] + ':', 20, rowY);
                doc.setTextColor(...dark);
                doc.setFont('helvetica', 'bold');
                doc.text(m[1], 80, rowY);
                doc.setFont('helvetica', 'normal');
                const statusColor = m[2].includes('!') || m[2].includes('Issue') ? [239, 68, 68] : 
                                    (m[2] === 'OK' ? [34, 197, 94] : [245, 158, 11]);
                doc.setTextColor(...statusColor);
                doc.text(m[2], 120, rowY);
            });
            
            // Frequency Balance
            if (r.spectrum) {
                y += 60;
                doc.setTextColor(...dark);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Frequency Balance', 20, y);
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(...gray);
                doc.text('Energy distribution (octave-normalized)', 20, y + 6);
                
                y += 14;
                const bands = [
                    { name: 'Low (20-250Hz)', value: r.spectrum.low, color: [59, 130, 246] },
                    { name: 'Mid (250Hz-4kHz)', value: r.spectrum.mid, color: [34, 197, 94] },
                    { name: 'High (4-16kHz)', value: r.spectrum.high, color: [245, 158, 11] }
                ];
                
                bands.forEach((band, i) => {
                    const rowY = y + (i * 12);
                    
                    doc.setTextColor(...gray);
                    doc.setFontSize(10);
                    doc.text(band.name, 20, rowY);
                    
                    // Bar background
                    doc.setFillColor(230, 230, 230);
                    doc.roundedRect(75, rowY - 4, 80, 6, 2, 2, 'F');
                    
                    // Bar fill
                    doc.setFillColor(...band.color);
                    doc.roundedRect(75, rowY - 4, band.value * 0.8, 6, 2, 2, 'F');
                    
                    // Value
                    doc.setTextColor(...dark);
                    doc.setFont('helvetica', 'bold');
                    doc.text(Math.round(band.value) + '%', 162, rowY);
                    doc.setFont('helvetica', 'normal');
                });
                
                y += 40;
                doc.setFontSize(8);
                doc.setTextColor(...gray);
                doc.text('Typical mix: Low ~30-35%, Mid ~40-45%, High ~20-30%', 20, y);
            }
            
            // Issues
            if (r.issues.length > 0) {
                y += 20;
                doc.setTextColor(...dark);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Issues Found', 20, y);
                
                y += 8;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                r.issues.forEach((issue, i) => {
                    const issueY = y + (i * 7);
                    const icon = issue.severity === 'bad' ? 'âŒ' : 'âš ï¸';
                    let text = issue.id.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    doc.setTextColor(issue.severity === 'bad' ? 239 : 245, issue.severity === 'bad' ? 68 : 158, issue.severity === 'bad' ? 68 : 11);
                    doc.text(icon + ' ' + text, 20, issueY);
                });
            }
            
            // Footer
            doc.setFillColor(...dark);
            doc.rect(0, 280, 210, 17, 'F');
            
            doc.setTextColor(...gray);
            doc.setFontSize(9);
            doc.text('guyshema.com', 105, 288, { align: 'center' });
            doc.setTextColor(...gold);
            doc.setFontSize(8);
            doc.text('oppenmasters Â© 2025', 105, 294, { align: 'center' });
            
            // Save
            const safeName = fileName.replace(/[^a-zA-Z0-9\-_\u0590-\u05FF]/g, '_').substring(0, 50);
            doc.save('oppenmasters_report_' + safeName + '.pdf');
        }

        function reset() {
            stopAudio();
            fileInput.value = '';
            fileInfo.classList.remove('show');
            uploadArea.classList.remove('has-file');
            loading.classList.remove('show');
            results.classList.remove('show');
            buffer = null;
            pauseTime = 0;
            window.lastAnalysis = null;
        }

        // Guidelines toggle
        document.getElementById('guidelinesHeader').addEventListener('click', () => {
            const content = document.getElementById('guidelinesContent');
            const arrow = document.getElementById('guidelinesArrow');
            content.classList.toggle('show');
            arrow.textContent = content.classList.contains('show') ? 'â–²' : 'â–¼';
        });

        // Utils
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1024 / 1024).toFixed(1) + ' MB';
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return m + ':' + (s < 10 ? '0' : '') + s;
        }

        function formatSampleRate(sr) {
            return (sr / 1000).toFixed(1) + 'kHz';
        }

        // Initialize language on page load
        setLang('en');
    </script>
</body>
</html>
